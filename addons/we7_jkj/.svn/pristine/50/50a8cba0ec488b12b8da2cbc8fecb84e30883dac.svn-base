{template 'header'}
<script>var require = { urlArgs: 'v=20170802' };</script>
<script type="text/javascript" src="./resource/js/app/util.js?v=20170802"></script>
<script type="text/javascript" src="./resource/js/app/common.min.js?v=20170802"></script>
<script type="text/javascript" src="./resource/js/require.js?v=20170802"></script>
<link href="{MODULE_URL}static/web/my.css" rel="stylesheet" type="text/css" />
<script>
    category = new Array();
    item = new Array();
    {loop $cate_list $type $v}
    category[{$type}] = new Array();
        {loop $v $vv}
        category[{$type}][{$vv['cat_id']}] = '{$vv['cat_name']}';
        item[{$vv['cat_id']}] = new Array();
            {loop $vv['item'] $vvv}
            item[{$vv['cat_id']}].push([{$vvv['item_id']}, '{$vvv['title']}']);
            {/loop}
        {/loop}
    {/loop}
</script>
<div class="page-container">
    <!-- BEGIN SIDEBAR -->
    {template 'leftmenu'}
    <!-- END SIDEBAR -->
    <!-- BEGIN CONTENT -->
    <div class="page-content-wrapper">
        <!-- BEGIN CONTENT BODY -->
        <div class="page-content">
            <!-- BEGIN PAGE HEADER-->
            <!-- BEGIN PAGE BAR -->

            <!-- END PAGE BAR -->
            <!-- BEGIN PAGE TITLE-->

            <!-- END PAGE TITLE-->
            <!-- END PAGE HEADER-->


            <div class="row">
                <div class="col-md-12">

                    <div class="tabbable-line boxless tabbable-reversed">
                        <ul class="nav nav-tabs">

                            <li id="listfl" {if $fun == 'display'||empty($fun)}class="active"{/if}>
                                <a href="{php echo $this->createWebUrl('products',array('fun'=>'display'));}" > 产品列表 </a><!--data-toggle="tab"-->
                            </li>
                            <li id="itemfl" class="dropdown {if $fun == 'post'}active{/if}">
                                <a class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                    添加产品
                                    <span class="caret"></span>
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                                    <li><a href="{php echo $this->createWebUrl('products',array('fun'=>'post', 'product_type' => 0));}">全屋定制</a></li>
                                    <li><a href="{php echo $this->createWebUrl('products',array('fun'=>'post', 'product_type' => 1));}">预约</a></li>
                                </ul>
                            </li>
                        </ul>
                        <div class="tab-content">
                            {if $fun == 'display' || $fun == 'search'}
                                <div class="tab-pane active" id="tab_0">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <form action="" method="get" class="form-horizontal">
                                                <input type="hidden" name="c" value="site">
                                                <input type="hidden" name="a" value="entry">
                                                <input type="hidden" name="m" value="gymy_cms">
                                                <input type="hidden" name="do" value="cmsProduct">
                                                <input type="hidden" name="fun" value="search">

                                                <div class="form-body">
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <div class="form-group form-md-line-input">
                                                                <label class="col-md-3 control-label">添加分类</label>
                                                                <div class="col-md-9">
                                                                    <select class="form-control" name="cateid" id="cateid">
                                                                        <option value="all">所有类别</option>
                                                                        {loop $productCate $v}
                                                                        <option value="{$v['id']}">{$v['cname']}</option>
                                                                        {/loop}
                                                                    </select>
                                                                    <div class="form-control-focus"> </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="form-group form-md-line-input  has-error">
                                                                <label class="col-md-3 control-label">关键词</label>
                                                                <div class="col-md-9">
                                                                    <input class="form-control" name="keyword" id="" type="text" value="{$_GPC['keyword']}">
                                                                    <div class="form-control-focus"> </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="form-group form-md-line-input ">
                                                                <input type="submit" name="submit_search" value="搜索" class="btn red-haze" />
                                                                <input type="hidden" name="token" value="{$_W['token']}">
                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>

                                            </form>

                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <!-- BEGIN EXAMPLE TABLE PORTLET-->
                                        <div class="portlet light portlet-fit ">
                                            <div class="portlet-body">
                                                <div class="table-scrollable">
                                                    <table class="table table-striped table-bordered table-advance table-hover" style="text-align: center;">
                                                        <thead>
                                                        <tr>
                                                            <th style="width:50px">序号</th>
                                                            <th style="width:50px">排序</th>
                                                            <th style="width:30%">商品名称</th>
                                                            <th style="width: 10%;">商品类型</th>
                                                            <th style="width:10%">状态</th>
                                                            <th style="text-align:center;">操作</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        {loop $list $index $item}
                                                        <tr>
                                                            <td>{php echo $index+1}</td>
                                                            <td>
                                                                {$item['sort_by']}
                                                            </td>
                                                            <td style="text-align: left;">
                                                                {$item['product_name']}
                                                            </td>
                                                            <td>
                                                                {if empty($item['product_type'])}全屋定制{else}预约{/if}
                                                            </td>
                                                            <td>
                                                                {if $item['status']}<span data-id="{$item['product_id']}" data-status="1" class="label label-success ishot">启用</span>
                                                                {else}<span data-id="{$item['product_id']}" data-status="0" class="label label-warning ishot">禁用</span>
                                                                {/if}
                                                            </td>

                                                            <td style="text-align:center; ">
                                                                <!--<a href="javascript:;" data-url="{php echo murl('site/site/detail', array('id' => $item['id']), true, true)}" class="js-clip" title="复制链接">复制链接</a>&nbsp;-&nbsp;-->
                                                                <a href="{php echo $this->createWebUrl('products',array('fun'=>'post','product_id' => $item['product_id']))}" title="编辑">编辑</a>&nbsp;-&nbsp;
                                                                <a onclick="return confirm('此操作不可恢复，确认吗？'); return false;" href="{php echo $this->createWebUrl('cmsProduct',array('fun'=>'delete','id' => $item['id']))}" title="删除">删除</a>
                                                            </td>
                                                        </tr>
                                                        {/loop}
                                                        </tbody>
                                                    </table>

                                                </div>
                                            </div>
                                        </div>
                                        <!-- END EXAMPLE TABLE PORTLET-->
                                    </div>
                                </div>
                            </div>
                            {/if}
                            {if $fun == 'post'}
                                <div class="tab-pane active" id="tab_1">
                                <div class="row">
                                    <div class="col-md-12">
                                        <!-- BEGIN PORTLET-->
                                        <div class="portlet light form-fit ">
                                            <div class="portlet-title">
                                                <div class="caption">
                                                    <i class="icon-pin font-red"></i>
                                                    <span class="caption-subject font-red sbold uppercase">编辑产品</span>
                                                </div>
                                            </div>
                                            <div class="portlet-body form">
                                                <!-- BEGIN FORM-->
                                                <form action="" method="post"  class="form-horizontal form-bordered">
                                                    <div class="form-body">
                                                        <!--<div class="form-group form-md-line-input app_home_list_style">
                                                            <label class="control-label col-md-3">商品类型</label>
                                                            <div class="col-md-4">
                                                                <div class="md-radio-inline">
                                                                    <div class="md-radio has-warning">
                                                                        <input type="radio" id="radioqw" name="product_type"  value="0" class="md-radiobtn" onchange="changeCategoryType()" {if empty($item['product_type'])}checked{/if} >
                                                                        <label for="radioqw">
                                                                            <span></span>
                                                                            <span class="check"></span>
                                                                            <span class="box"></span> 全屋定制 </label>
                                                                    </div>
                                                                    <div class="md-radio has-warning">
                                                                        <input type="radio" id="radioyy" name="product_type"  value="1"  class="md-radiobtn" onchange="changeCategoryType()" {if !empty($item['product_type'])}checked{/if}>
                                                                        <label for="radioyy">
                                                                            <span></span>
                                                                            <span class="check"></span>
                                                                            <span class="box"></span> 预约 </label>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>-->
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">类别</label>
                                                            <div class="col-md-1">
                                                                <a href="javascript:;" onclick="addCategory()" class="btn green">添加分类</a>
                                                            </div>
                                                        </div>
                                                        <div id="product_cats">
                                                            {loop $item['product_cat'] $product_cat}
                                                            <div class="form-group form-md-line-input">
                                                                <label class="control-label col-md-3">{$row['attr_name']}</label>
                                                                <div class="col-md-2">
                                                                    <select name="cat_id[]" onchange="changeCategory(this)">
                                                                        <option value="0">请选择</option>
                                                                        {loop $cate_list[$item['product_type']] $row}
                                                                        <option value="{$row['cat_id']}" {if $row['cat_id'] == $product_cat['cat_id']}selected{/if}>{$row['cat_name']}</option>
                                                                        {/loop}
                                                                    </select>
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <select name="item_id[]">
                                                                        <option value="0">请选择</option>
                                                                        {loop $cate_list[$item['product_type']][$product_cat['cat_id']]['item'] $row}
                                                                        <option value="{$row['item_id']}" {if $row['item_id'] == $product_cat['item_id']}selected{/if}>{$row['title']}</option>
                                                                        {/loop}
                                                                    </select>
                                                                </div>
                                                                <div class="col-md-1">
                                                                    <a href="javascript:;" onclick="deleteProductCat(this)" class="btn green">-</a>
                                                                    <input type="hidden" name="id[]" value="{$product_cat['id']}" />
                                                                </div>
                                                            </div>
                                                            {/loop}
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">商品名称</label>
                                                            <div class="col-md-3">
                                                                <input type="text" class="form-control" placeholder="" name="product_name" value="{$item['product_name']}">
                                                                <div class="form-control-focus"> </div>
                                                            </div>
                                                        </div>
                                                        {if $item['product_type'] == '0'}
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">商品价格</label>
                                                            <div class="col-md-3">
                                                                <input type="text" class="form-control" placeholder="" name="price" value="{$item['price']}">
                                                                <div class="form-control-focus"> </div>
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">简介</label>
                                                            <div class="col-md-3">
                                                                <textarea class="form-control" name="description" rows="3">{$item['description']}</textarea>
                                                                <div class="form-control-focus"> </div>
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">排序</label>
                                                            <div class="col-md-3">
                                                                <input type="number" min="0"  class="form-control" placeholder="" name="sort_by" value="{$item['sort_by']}">
                                                                <div class="form-control-focus"> </div>
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">是否启用</label>
                                                            <div class="col-md-3">
                                                                <input id="status" name="status" type="checkbox" class="make-switch"  data-size="small" data-on-color="success" data-off-color="warning" data-on-text="启用" data-off-text="禁用" {if !empty($item['status']) || !$product_id} checked{/if}>
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">主图</label>
                                                            <div class="col-md-4">
                                                                {php echo tpl_form_field_multi_image('product_img', $item['product_image'])}
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">缩略图</label>
                                                            <div class="col-md-4">
                                                                {php echo tpl_form_field_image('product_thumb', $item['product_thumb'])}
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">商品属性</label>
                                                            <div class="col-md-4">
                                                                <select id="attr_id">
                                                                    {loop $attr_list $attr}
                                                                    <option value="{$attr['attr_id']}">{$attr['attr_name']}</option>
                                                                    {/loop}
                                                                </select>
                                                                <a href="javascript:addAttr();" class="btn green">+</a>
                                                            </div>
                                                        </div>
                                                        <div id="attrs">
                                                            {loop $item['attr'] $row}
                                                            <div class="form-group form-md-line-input">
                                                                <label class="control-label col-md-3">{$row['attr_name']}</label>
                                                                <div class="col-md-4">
                                                                    <input type="text" name="attr_value[]" class="form-control" value="{$row['attr_value']}">
                                                                    <input type="hidden" name="attr_id[]" value="{$row['attr_id']}">
                                                                    <input type="hidden" name="product_attr_id[]" value="{$row['product_attr_id']}">
                                                                </div>
                                                                <div class="col-md-1">
                                                                    <a href="javascript:;" onclick="deleteAttr(this)" class="btn green">-</a>
                                                                </div>
                                                            </div>
                                                            {/loop}
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">商品关联</label>
                                                            <div class="col-md-3">
                                                                <input type="text" class="form-control" id="key" value="" placeholder="输入商品名搜索">
                                                            </div>
                                                            <div class="col-md-1">
                                                                <a href="javascript:;" onclick="searchProducts()" class="btn green">搜索</a>
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3"></label>
                                                            <div class="col-md-3">
                                                                <select class="form-control" id="link_product"></select>
                                                            </div>
                                                            <div class="col-md-1">
                                                                <a href="javascript:;" onclick="addLinkProducts()" class="btn green">+</a>
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">关联商品</label>
                                                            <div id="product_links">
                                                            {loop $item['product_link'] $row}
                                                                <div class="col-md-1">
                                                                    <label>
                                                                        <input type="checkbox" onclick="editLink({$row['product_id']}, this)" checked value="{$row['product_id']}">
                                                                        {$row['product_name']}
                                                                    </label>
                                                                </div>
                                                            {/loop}
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">直接链接</label>
                                                            <div class="col-md-3">
                                                                {php echo tpl_form_field_link('linkurl', $item['linkurl']);}
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">商品详情</label>
                                                            <div class="col-md-7">
                                                                {php echo tpl_ueditor('product_details', $item['product_details']);}
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">配送安装</label>
                                                            <div class="col-md-7">
                                                                {php echo tpl_ueditor('product_shipping', $item['product_shipping']);}
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">产品配件</label>
                                                            <div class="col-md-7">
                                                                {php echo tpl_ueditor('product_suite', $item['product_suite']);}
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input" style="display: none">
                                                            <script type="text/javascript">
                                                                require(['util'], function(util){
                                                                    util.editor('product_details', {});
                                                                    util.editor('product_shipping', {});
                                                                    util.editor('product_suite', {});
                                                                });
                                                            </script>
                                                        </div>
                                                        {elseif $item['product_type'] == '1'}
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">所属商店</label>
                                                            <div class="col-md-3">
                                                                <select id="shop_id" name="shop_id" class="form-control">
                                                                    <option value="0">请选择</option>
                                                                    {loop $shop_list $shop}
                                                                    <option value="{$shop['shop_id']}" {if $shop['shop_id'] == $item['shop']['shop_id']}selected{/if}>{$shop['shop_name']}</option>
                                                                    {/loop}
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">直接链接</label>
                                                            <div class="col-md-3">
                                                                {php echo tpl_form_field_link('linkurl', $item['linkurl']);}
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">是否启用</label>
                                                            <div class="col-md-3">
                                                                <input id="status" name="status" type="checkbox" class="make-switch"  data-size="small" data-on-color="success" data-off-color="warning" data-on-text="启用" data-off-text="禁用" {if !empty($item['status']) || !$product_id} checked{/if}>
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">主图</label>
                                                            <div class="col-md-4">
                                                                {php echo tpl_form_field_image('product_img', $item['product_img'])}
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">缩略图</label>
                                                            <div class="col-md-4">
                                                                {php echo tpl_form_field_image('product_thumb', $item['product_thumb'])}
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">简介</label>
                                                            <div class="col-md-3">
                                                                <textarea class="form-control" name="description" rows="3">{$item['description']}</textarea>
                                                                <div class="form-control-focus"> </div>
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input">
                                                            <label class="control-label col-md-3">商品介绍</label>
                                                            <div class="col-md-7">
                                                                {php echo tpl_ueditor('product_details', $item['product_details']);}
                                                            </div>
                                                        </div>
                                                        <div class="form-group form-md-line-input" style="display: none">
                                                            <script type="text/javascript">
                                                                require(['util'], function(util){
                                                                    util.editor('product_details', {});
                                                                });
                                                            </script>
                                                        </div>
                                                        {/if}
                                                        <div class="modal-footer">
                                                            <input  type="submit" name='submit' class="btn green" data-dismiss="modal" value="提交" />
                                                            <input type="hidden" name="token" value="{$_W['token']}">
                                                            <input type="hidden" name="product_id" id="product_id" value="{$product_id}">
                                                            <input type="hidden" name="product_type" id="product_type" value="{$item['product_type']}">
                                                        </div>
                                                    </div>
                                                </form>

                                                <!-- END FORM-->
                                            </div>
                                        </div>
                                        <!-- END PORTLET-->
                                    </div>
                                </div>
                            </div>
                            {/if}

                        </div>
                    </div>

                </div>
            </div>
            <!-- BEGIN : RIBBONS -->

            <!-- END : RIBBONS -->
        </div>
        <!-- END CONTENT BODY -->
    </div>
    <!-- END CONTENT -->
</div>
<!-- END CONTAINER -->


{template 'footer'}



<script>

    $(document).ready(function () {
        active($('#li_module'),$('#li_module_notice'));
        $('.form-group').css('padding-top','0px');
    });
    $('.isedit').click( function () {
        var id = $(this).attr('data-id');
        $('#listfl').removeClass('active');
        $('#itemfl').addClass('active');
        $('#tab_0').removeClass('active');
        $('#tab_1').addClass('active');
        $('#tab_1').addClass('active');
        $('#tab_1').addClass('active');

        $('#catname').val($(this).parents("tr").children("td:eq(3)").text());
        $('#catdisplayorder').val($(this).parents("tr").children("td:eq(1)").find("input").val());
        $('#catisindex').bootstrapSwitch('state',$(this).parents("tr").children("td:eq(4)").find("input").bootstrapSwitch('state'));
        $('#catisstatus').bootstrapSwitch('state',$(this).parents("tr").children("td:eq(5)").find("input").bootstrapSwitch('state'));
        $("input[name='pic']").val($(this).parents("tr").children("td:eq(2)").find("img").attr('src'));
        $('.img-thumbnail').attr('src',$(this).parents("tr").children("td:eq(2)").find("img").attr('src'));
        $('#catid').val($(this).parents("tr").children("td:eq(0)").text());
    });

    $('.importcat').on('confirmed.bs.confirmation', function () {
        $.ajax({
            // var txt =$(this);
            url: '{php echo $this->createWebUrl("itemsfl",array("fun"=>"importcat"))}',
            success: function (status) {
                if (status == '1') {
                    //location.reload();
                    require(['util'], function (util) {
                        util.message("导入成功", "{php echo $_W['siteurl']}", 'success');
                    });
                }
            }
        });
    });
    $('.isdelete').on('confirmed.bs.confirmation', function () {
        $.ajax({
            // var txt =$(this);
            url: '{php echo $this->createWebUrl("itemsfl",array("fun"=>"del"))}',
            type: 'post',
            data: {id: $(this).attr('data-id')},
            success: function (status) {
                if (status == '1') {
                    //location.reload();
                    require(['util'], function (util) {
                        util.message("删除成功", "{php echo $_W['siteurl']}", 'success');
                    });
                }
            }
        });
    });

    $('.sorting').blur(function () {
            $.ajax({
                // var txt =$(this);
                url:'{php echo $this->createWebUrl("itemsfl",array("fun"=>"sorting"))}',
                type:'post',
                data:{id:$(this).attr('data-id'),displayorder:$(this).val()},
                success:function(status){
                    if(status == '1'){
                        $.bootstrapGrowl('更新成功', {
                            ele: 'body', // which element to append to
                            type: 'success', // (null, 'info', 'danger', 'success', 'warning')
                            offset: {
                                from: 'bottom',
                                amount: 100
                            }, // 'top', or 'bottom'
                            align: 'right', // ('left', 'right', or 'center')
                            width: 150, // (integer, or 'auto')
                            delay: 2000, // Time while the message will be displayed. It's not equivalent to the *demo* timeOut!
                            allow_dismiss: true, // If true then will display a cross to close the popup.
                            stackup_spacing: 10 // spacing between consecutively stacked growls.
                        });
                    }else {
                        $.bootstrapGrowl('未更新', {
                            ele: 'body', // which element to append to
                            type: 'warning', // (null, 'info', 'danger', 'success', 'warning')
                            offset: {
                                from: 'bottom',
                                amount: 100
                            }, // 'top', or 'bottom'
                            align: 'right', // ('left', 'right', or 'center')
                            width: 150, // (integer, or 'auto')
                            delay: 2000, // Time while the message will be displayed. It's not equivalent to the *demo* timeOut!
                            allow_dismiss: true, // If true then will display a cross to close the popup.
                            stackup_spacing: 10 // spacing between consecutively stacked growls.
                        });
                    }
                }
            });
        }
    );

    $('.ishot').click( function(event) {
            var span=$(this)
            var id = $(this).attr('data-id');
            var status=$(this).attr('data-status');
            //alert(state);
            if (status==1) { // 如果状态为 on, 需要开启模态框
                $.ajax({
                    url:'{php echo $this->createWebUrl("products",array("fun"=>"ajax", "op" => "status"))}',
                    type:'post',
                    data:{product_id:id,status:'0'},
                    success:function(status){
                        if(status == '1'){
                            span.removeClass('label-success').addClass('label-warning');
                            span.text('禁用');
                            span.attr('data-status','0');
                        }
                    }
                });
            } else { // 如果当前状态为off
                $.ajax({
                    url:'{php echo $this->createWebUrl("products",array("fun"=>"ajax", "op" => "status"))}',
                    type:'post',
                    data:{product_id:id,status:'1'},
                    success:function(status){
                        if(status == '1'){
                            span.removeClass('label-warning').addClass('label-success');
                            span.text('启用');
                            span.attr('data-status','1');
                        }
                    },

                });
            }
        }
    );


    $('.isindex').on(  'switchChange.bootstrapSwitch', function(event, state) {
            var label = $(this);
            if (state) { // 如果状态为 on, 需要开启模态框
                $.ajax({
                    url:'{php echo $this->createWebUrl("itemsfl",array("fun"=>"isindex"))}',
                    type:'post',
                    data:{id:label.attr('data-id'),isindex:'1'},
                    success:function(status){
                        if(status == '1'){
                        }
                    }
                });
            } else { // 如果当前状态为off
                $.ajax({
                    url:'{php echo $this->createWebUrl("itemsfl",array("fun"=>"isindex"))}',
                    type:'post',
                    data:{id:label.attr('data-id'),isindex:'0'},
                    success:function(status){
                        if(status == '1'){

                        }
                    }
                });
            }
        }
    );

    function addAttr(){
        var select = $('#attr_id');
        if(select.find('option').length == 0){
            return false;
        }

        var attr_id = select.val();
        var attr_name = select.find('option:selected').text();

        var html = '<div class="form-group form-md-line-input">' +
                '<label class="control-label col-md-3">'+attr_name+'</label>' +
                '<div class="col-md-4">' +
                '<input type="text" name="attr_value[]" class="form-control" value="">' +
                '<input type="hidden" name="attr_id[]" value="'+attr_id+'">' +
                '<input type="hidden" name="product_attr_id[]" value="0">' +
                '</div>' +
                '<div class="col-md-1">' +
                '<a href="javascript:;" onclick="deleteAttr(this)" class="btn green">-</a>' +
                '</div>' +
                '</div>';

        $('#attrs').append(html);
    }

    function deleteAttr(obj){
        $(obj).parents('div.form-md-line-input').remove();
    }

    function deleteProductCat(obj){
        $(obj).parents('div.form-md-line-input').remove();
    }

    function searchProducts(){
        var key = $('#key').val();
        var product_id = $('#product_id').val();

        $.ajax({
            url: '{php echo $this->createWebUrl("products",array("fun"=>"ajax", "op"=>"search"))}',
            type: 'post',
            data: {
                key: key,
                product_id: product_id
            },
            datatype: 'json',
            success: function (data) {
                var data = eval('(' + data + ')');

                $('#link_product option').remove();

                for(x in data){
                    $('#link_product').append('<option value="'+data[x]['product_id']+'">'+data[x]['product_name']+'</option>');
                }
            }
        })
    }

    function addLinkProducts(){
        var product_id = $('#product_id').val();
        var link_product_id = $('#link_product').val();

        if($('#link_product option').length==0){
            return false;
        }

        $.ajax({
            url: '{php echo $this->createWebUrl("products",array("fun"=>"ajax", "op"=>"link"))}',
            type: 'post',
            data: {
                product_id: product_id,
                link_product_id: link_product_id,
                checked:1
            },
            success: function (status) {
                if(status == '1'){
                    var text = $('#link_product').find('option:selected').text();
                    var html = '<div class="col-md-1">' +
                            '<label>' +
                            '<input type="checkbox" onclick="editLink('+link_product_id+', this)" checked value="'+link_product_id+'">' +
                            text +
                            '</label>' +
                            '</div>';
                    $('#product_links').append(html);
                }
            }
        })
    }

    function editLink(link_id, obj){
        var product_id = $('#product_id').val();

        $.ajax({
            url: '{php echo $this->createWebUrl("products",array("fun"=>"ajax", "op"=>"link"))}',
            type: 'post',
            data: {
                product_id: product_id,
                link_product_id: link_id,
                checked:obj.checked ? 1 : 0
            },
            success: function (status) {
                if(status == '1'){
                }
            }
        })
    }

    function deleteStyle(obj, sid){
        var product_id = $('[name="product_id"]').val();

        $.ajax({
            url: '{php echo $this->createWebUrl("products",array("fun"=>"ajax", "op"=>"delete_style"))}',
            type: 'post',
            data: {
                sid: sid,
                product_id: product_id,
            },
            datatype: 'json',
            success: function (status) {
                if(status == 0){
                    $(obj).parents('div.form-md-line-input').remove();
                }else{
                    alert('删除失败');
                }

            }
        })
    }

    function changeCategoryType(){
        $('#product_cats').empty();
    }

    function addCategor1y(){
        var product_id = $('[name="product_id"]').val();
        var product_type = $('[name="product_type"]:checked').val();

        $.ajax({
            url: '{php echo $this->createWebUrl("ajax",array("fun"=>"products", "op"=>"delete_style"))}',
            type: 'post',
            data: {
                sid: sid,
                product_id: product_id,
            },
            datatype: 'json',
            success: function (status) {
                if(status == 0){
                    $(obj).parents('div.form-md-line-input').remove();
                }else{
                    alert('删除失败');
                }

            }
        })
    }

    function addCategory(cat_id, item_id){
        var product_type = $('[name="product_type"]').val();

        if(typeof product_type == 'undefined'){
            return false;
        }

        html = '<div class="form-group form-md-line-input">' +
            '<label class="control-label col-md-3">{$row['attr_name']}</label>' +
            '<div class="col-md-2">' +
            '<select name="cat_id[]" onchange="changeCategory(this)">' +
            '<option value="0">请选择</option>';
        for(x in category[product_type]){
            html += '<option value="'+x+'">'+category[product_type][x]+'</option>';
        }
        html += '</select></div>' +
                '<div class="col-md-2">' +
                '<select name="item_id[]">' +
                '<option value="0">请选择</option>' +
                '</select>' +
                '</div>' +
                '<div class="col-md-1">' +
                '<a href="javascript:;" onclick="deleteProductCat(this)" class="btn green">-</a>' +
                '<input type="hidden" name="id[]" value="0" />' +
                '</div>' +
                '</div>';

        $('#product_cats').append(html);
    }

    function changeCategory(obj){
        cat_id = obj.value;
        product_cat =$(obj).parent().next().find('select[name="item_id[]"]');

        product_cat.empty();
        product_cat.append('<option value="0">请选择</option>');
        for(x in item[cat_id]){
            product_cat.append('<option value="'+item[cat_id][x][0]+'">'+item[cat_id][x][1]+'</option>');
        }
    }

</script>

